services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    # Start Redis with requirepass only when REDIS_PASSWORD is non-empty.
    # Use a small shell wrapper because docker-compose cannot conditionally omit
    # arguments based on environment variables directly.
    command: ["sh", "-c", "if [ -n \"${REDIS_PASSWORD}\" ]; then exec redis-server --requirepass \"${REDIS_PASSWORD}\"; else exec redis-server; fi"]

  web:
    build: .
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - FLASK_HOST=${FLASK_HOST:-0.0.0.0}
      - LICHESS_CLIENT_ID=${LICHESS_CLIENT_ID:-}
      - LICHESS_CLIENT_SECRET=${LICHESS_CLIENT_SECRET:-}
      # Prefer DATABASE_URL for Postgres deployments. If not set, fall back to sqlite file.
      - DATABASE_URL=${DATABASE_URL:-}
      - DATABASE_FILE=/data/db.sqlite
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - PGHOST=${POSTGRES_HOST:-postgres}
      - PGPORT=${POSTGRES_PORT:-5432}
      - PGUSER=${POSTGRES_USER:-postgres}
      - PGPASSWORD=${POSTGRES_PASSWORD:-postgres}
      - PGDATABASE=${POSTGRES_DB:-chesspuzzle}
      # Postgres connection - prefer DATABASE_URL, but also expose individual vars
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-chesspuzzle}
      # Celery / Redis broker (use REDIS_PASSWORD if set)
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
    volumes:
      - chesspuzzle-data:/data
    restart: unless-stopped
    ports:
      - "5000:5000"
    depends_on:
      - redis
      - postgres

  worker:
    build: .
    # Wait for Postgres (if configured) before starting the Celery worker to
    # avoid a race where the worker starts, cannot bind to Postgres, and
    # falls back to sqlite. The wait_for_db script exits quickly when no
    # Postgres configuration is present so this is safe for sqlite-only dev.
    command: ["sh", "-c", "python3 /app/scripts/wait_for_db.py && celery -A tasks worker --loglevel=info"]
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - LICHESS_CLIENT_ID=${LICHESS_CLIENT_ID:-}
      - LICHESS_CLIENT_SECRET=${LICHESS_CLIENT_SECRET:-}
      - DATABASE_URL=${DATABASE_URL:-}
      - DATABASE_FILE=/data/db.sqlite
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - PGHOST=${POSTGRES_HOST:-postgres}
      - PGPORT=${POSTGRES_PORT:-5432}
      - PGUSER=${POSTGRES_USER:-postgres}
      - PGPASSWORD=${POSTGRES_PASSWORD:-postgres}
      - PGDATABASE=${POSTGRES_DB:-chesspuzzle}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-chesspuzzle}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
    volumes:
      - chesspuzzle-data:/data
    restart: unless-stopped
    depends_on:
      - redis
      - postgres

  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-chesspuzzle}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-chesspuzzle}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # management service for one-off admin tasks (run with `docker compose run --rm manage <cmd>`)
  manage:
    build: .
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DATABASE_URL=${DATABASE_URL:-}
      - DATABASE_FILE=/data/db.sqlite
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-chesspuzzle}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
    volumes:
      - chesspuzzle-data:/data
    # do not restart; intended for one-off interactive runs
    restart: 'no'
    depends_on:
      - redis
      - postgres

volumes:
  chesspuzzle-data:
  redis-data:
  postgres-data:
