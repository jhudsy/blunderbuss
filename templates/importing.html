<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/static/favicon-96x96.png" type="image/png" sizes="96x96">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <title>Downloading gamesâ€¦</title>
  <link rel="stylesheet" href="/vendor/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    .spinner { text-align: center; margin-top: 4rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Preparing your puzzles</h1>
    <p>We're downloading your games from Lichess and importing puzzles. This may take a minute.</p>
    <div class="spinner">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div id="status-text" style="margin-top:1rem">Starting...</div>
    </div>
  </div>

  <script>
    const pollInterval = 2000; // ms
    function checkStatus() {
      fetch('/api/import_status', { credentials: 'same-origin' })
        .then(r => {
          if (!r.ok) throw new Error('status ' + r.status);
          return r.json();
        })
        .then(json => {
          if (json.status === 'not_logged_in') {
            window.location.href = '/login';
            return;
          }
          if (json.status === 'no_user') {
            document.getElementById('status-text').innerText = 'No user found';
            return;
          }
          if (json.status === 'error') {
            document.getElementById('status-text').innerText = 'Error checking import status';
            return;
          }
          const total = json.total || 0;
          const done = json.done || 0;
          if (total > 0) {
            document.getElementById('status-text').innerText = `Importing puzzles: ${done} / ${total}`;
          } else {
            document.getElementById('status-text').innerText = 'Downloading games...';
          }
          if (json.status === 'done') {
            // Redirect to the puzzle page when import is finished
            window.location.href = '/';
            return;
          }
          setTimeout(checkStatus, pollInterval);
        })
        .catch(err => {
          document.getElementById('status-text').innerText = 'Network error while checking import status...';
          setTimeout(checkStatus, pollInterval * 2);
        });
    }
    // Start polling after a short delay to give the worker time to set counters
    setTimeout(checkStatus, 500);
  </script>
</body>
</html>
